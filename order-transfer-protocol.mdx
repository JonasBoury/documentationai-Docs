---
title: Order Transfer Protocol
description: >-
  A simple way to use blockchain transactions and smart contract accounts to
  complete a payment order using an ERC20 token
---
## Intro

üõí As a place, you should be able to request payment with a specific token for a specific amount with details about the payment.

üõçÔ∏è As a customer, you should be able to know how much you should pay, to whom and for what.

‚úÖ When the payment is executed, the customer and place should be able to confirm that it is done.

## In Short

1. A place requests payment with a link

   1. Display as a QR code or send it

2. A customer completes the payment using the link

## Terminology

- **Order** = request for a payment

- **Place** = a virtual or physical location where payments are collected, can generate orders

- **Business** = merchant, can have multiple places

## Request Payment QR Code (generated by the place)

A link which allows opening a payment page directly in the web browser and/or deeplinking into a native app.

This will be displayed on another device as a QR Code.

Process:

1. Place decides how much

2. Generates code on their device

3. Checks order status while waiting for user to scan and complete the flow

## Order completion (performed by the customer)

Once the user has information about the order, they can be prompted to transfer tokens to complete the order.

Process:

1. Scans QR Code

2. Opens app

3. Fetch order information

4. Displays order and place information

5. Customer executes a transaction of tokens to the address of the place

6. Customer completes the order by attaching the transaction hash to the order

## Link format explained

`https://checkout.citizenpay.xyz/demo-pizza?orderId=456`

### Base URL

`https://checkout.citizenpay.xyz/`

It is used to land the user somewhere in case they don't have the app or allow them to do a web checkout directly.

### Place

- slug: `demo-pizza`

- id: `2`

- address: `0x99cE1D43D64DD72C1Fa9f71684253F319c374BFc`

Every place can reserve a slug which is unique to them. This can be used to reference them in a user-friendly way. It is also possible to use their system id or the underlying on-chain account address.

### Order ID

`456`

Every interaction between customer and place happens through orders.

An order contains metadata about the payment as well as references to on-chain transactions and also the status of the payment.

Status:

- `pending` - awaiting payment

- `paid` - payment is confirmed

- `cancelled` - payment was cancelled

- `refunded` - this order was refunded

- `refund` - the actual refund (reverse transaction)

## Orders

### How to fetch a pending order

**GET** `https://checkout.citizenpay.xyz/api/v1/app/places/[slug or placeId or 0x...]/orders/[orderId]`

The response will include the order and information about the place.

### How to complete a pending order

**PATCH** `https://checkout.citizenpay.xyz/api/v1/app/places/[slug or placeId or 0x...]/orders/[orderId]`

#### Body

```json
{
  "txHash": "0x4c493e40b2f780fd2d32a6d1fcac276d937f05fbf7249d836e142fefbc10e33c",
  "account": "0x85655C32A81717961874A5b7AEf895fd981c29b1"
}
```

#### Headers

Generate a signature, sign it and pass in the headers of your request.

Use the SDK to generate the headers: [@citizenwallet/sdk](https://www.npmjs.com/package/@citizenwallet/sdk)

Look for the following function:

```typescript
generateConnectedHeaders(
  signer: Signer,
  accountAddress: string,
  expiryTimeStamp: string,
  redirectUrl?: string
): Promise<object>
```

- `signer` = the owner of your smart contract account (can validate `eip1271`)

- `accountAddress` = the smart contract account address

- `expiryTimeStamp` = how long should your request be valid for (pick something sane)

- no need for a redirect url

#### Validation

- the receiving address must match the place's account address (you cannot complete with a tx that doesn't benefit the place)

- you must be the sender of the tx (you cannot "steal" someone's transaction)

- the amount must match the total order amount (the amount sent should complete the order)

#### What does it do?

1. check that the order is in a pending state

2. check that you are the owner of the sender's account

3. check that the `txHash` was not already used on another order

4. wait for confirmation on-chain of the `txHash`

5. check the related on-chain receipt for the amount and receiver to make sure it matches the order

6. complete the order

7. return the completed order to the requester

#### Response

The completed order will be returned.

### Structure of an order

```typescript
export type OrderStatus =
  | "pending"
  | "paid"
  | "cancelled"
  | "needs_minting"
  | "needs_burning"
  | "refunded"
  | "refund"
  | "correction";

export interface Order {
  id: number;
  created_at: string;
  completed_at: string | null;
  total: number; // in cents (2 decimals)
  due: number; // in cents (2 decimals)
  fees: number; // in cents (2 decimals) // tx fees taken by visa/mastercard/etc...
  place_id: number;
  items: {
    id: number;
    quantity: number;
  }[];
  status: OrderStatus;
  description: string;
  tx_hash: string | null;
  type: "web" | "app" | "terminal" | null;
  account: string | null;
  payout_id: number | null;
  pos: string | null;
  processor_tx: number | null;
  refund_id: number | null;
  token: string | null; // which token is expected for this payment
  place: Place;
}
```

### Structure of a place

```typescript
export interface Place {
  id: number;
  created_at: string;
  business_id: number;
  slug: string;
  name: string;
  accounts: string[]; // pick the first one
  invite_code: string | null;
  terminal_id: number | null;
  image: string | null;
  description: string | null;
  display: "amount" | "menu" | "amountAndMenu" | "topup";
  hidden: boolean;
}
```

## Transaction

`token address = order.token`

`to = order.place.accounts[0]`

`value = parseUnits((order.total / 100).toFixed(2), token.decimals)`

## Brussels Pay Example Link

`https://checkout.pay.brussels/demo-pizza?orderId=5820`



<Image uid="d10181b5-ec67-4a2b-b805-23baa1869fb5" src="https://blob-cdn.documentation.ai/org-f9a33560-cb9b-4d66-b66c-511f736111a4/doc-b72060e3-2226-4e90-913e-c19fe16e0465/1763328009021-75we7i1ei4u-Order-Transfer-Protocol-Image.png" width="600" height="1300" alt="" />

<Image uid="0e249069-1b08-47a7-baa4-2e3e453bcb56" src="https://blob-cdn.documentation.ai/org-f9a33560-cb9b-4d66-b66c-511f736111a4/doc-b72060e3-2226-4e90-913e-c19fe16e0465/1763328031081-xdq6eidihas-Order-Transfer-Protocol-Image-2.png" width="600" height="1300" alt="" />

No app installation required

Handle the confirmation flow directly in the app.
